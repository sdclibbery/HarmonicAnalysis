import Codec.Midi
import Data.List
import Data.Ratio
import Structure
import Note
import Compose

--main = createMidi "test.midi" $ music [ [c, d].>>2, [e, f].>>2, [g, a].>>2 ]

main = createMidi "test.midi" $ music [ [c, d, g, a, c'.>2, b, a, g, f, d, b_, c.>4] ]


type Pitch = Int
type MidiEvent = (Ticks, Message)

makeTrack :: Part -> (Track Ticks)
makeTrack (Part p es) = [
   (0,ChannelPrefix 0),
   (0,TrackName " Grand Piano  "),
   (0,InstrumentName "GM Device  1"),
   (0,TimeSignature 4 2 24 8),
   (0,KeySignature 0 0)
  ]
  ++
  concatMap playEvent es
  ++
  [
   (1000,TrackEnd)
  ]

ticksPerBeat :: Int
ticksPerBeat = 480

beatsPerBar :: Int
beatsPerBar = 4

playEvent :: Event -> (Track Ticks)
--playEvent (Rest d) = 
playEvent (Note d n) = playnote (absChromatic n) d

playnote :: Pitch -> Structure.Time -> Track Ticks
playnote k d = [keydown k, keyup k]
  where
    keydown k = (0, NoteOn {channel = 0, key = k, velocity = 120})
    keyup k = (truncate $ (fromIntegral $ ticksPerBeat * beatsPerBar) * (fromRational d), NoteOn {channel = 0, key = k, velocity = 0})

createMidi :: FilePath -> Music -> IO()
createMidi f (Music ps) = exportFile f $ Midi {
         fileType = MultiTrack, 
         timeDiv = TicksPerBeat ticksPerBeat, 
         tracks = map makeTrack ps
       }
